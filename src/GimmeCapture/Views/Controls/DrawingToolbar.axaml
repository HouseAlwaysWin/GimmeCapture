<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:shared="using:GimmeCapture.ViewModels.Shared"
             xmlns:m="using:GimmeCapture.Models"
             xmlns:media="using:Avalonia.Media"
             xmlns:services="using:GimmeCapture.Services.Core"
             xmlns:c="using:GimmeCapture.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="36"
             x:Class="GimmeCapture.Views.Controls.DrawingToolbar"
             x:DataType="shared:IDrawingToolViewModel"
             TextElement.FontSize="12">

    <StackPanel Orientation="Horizontal" Spacing="2">
        <!-- Shapes & Lines -->
        <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                        Classes.active="{Binding IsShapeToolActive}"
                        ToolTip.Tip="{Binding [TipShapes], Source={x:Static services:LocalizationService.Instance}}">
            <Button.Flyout>
                <Flyout Placement="Top">
                    <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="2" CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="2" TextElement.FontSize="12">
                            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                                           Classes.active="{Binding CurrentAnnotationTool, ConverterParameter={x:Static m:AnnotationType.Rectangle}, Converter={StaticResource EnumToBoolConverter}}"
                                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Rectangle}" ToolTip.Tip="{Binding [TipRectangle], Source={x:Static services:LocalizationService.Instance}}">
                                <PathIcon Data="M19,3H5C3.89,3,3,3.89,3,5v14c0,1.1,0.89,2,2,2h14c1.1,0,2-0.89,2-2V5C21,3.89,20.1,3,19,3z M19,19H5V5h14V19z" Width="14" Height="14"/>
                            </Button>
                            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                                           Classes.active="{Binding CurrentAnnotationTool, ConverterParameter={x:Static m:AnnotationType.Ellipse}, Converter={StaticResource EnumToBoolConverter}}"
                                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Ellipse}" ToolTip.Tip="{Binding [TipEllipse], Source={x:Static services:LocalizationService.Instance}}">
                                <PathIcon Data="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8 S16.41,20,12,20z" Width="14" Height="14"/>
                            </Button>
                            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                                           Classes.active="{Binding CurrentAnnotationTool, ConverterParameter={x:Static m:AnnotationType.Arrow}, Converter={StaticResource EnumToBoolConverter}}"
                                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Arrow}" ToolTip.Tip="{Binding [TipArrow], Source={x:Static services:LocalizationService.Instance}}">
                                <PathIcon Data="M9,5v2h6.59L4,18.59L5.41,20L17,8.41V15h2V5H9z" Width="14" Height="14"/>
                            </Button>
                            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                                           Classes.active="{Binding CurrentAnnotationTool, ConverterParameter={x:Static m:AnnotationType.Line}, Converter={StaticResource EnumToBoolConverter}}"
                                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Line}" ToolTip.Tip="{Binding [TipLine], Source={x:Static services:LocalizationService.Instance}}">
                                 <PathIcon Data="M3,11h18v2H3V11z" Width="14" Height="14"/>
                             </Button>
                        </StackPanel>
                    </Border>
                </Flyout>
            </Button.Flyout>
            <Panel>
                <TextBlock Text="□" IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Rectangle}}" FontSize="14"/>
                <TextBlock Text="○" IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Ellipse}}" FontSize="14"/>
                <TextBlock Text="↗" IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Arrow}}" FontSize="14"/>
                <TextBlock Text="—" IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Line}}" FontSize="14"/>
                <TextBlock Text="⬚" IsVisible="{Binding IsShapeToolActive, Converter={StaticResource BoolInvertConverter}}" FontSize="14"/>
            </Panel>
        </Button>

        <!-- Pen Tool (Separate) -->
        <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                        Classes.active="{Binding IsPenToolActive}"
                        Command="{Binding ToggleToolGroupCommand}" CommandParameter="Pen"
                        ToolTip.Tip="{Binding [TipPen], Source={x:Static services:LocalizationService.Instance}}">
             <PathIcon Data="M3,17.25V21h3.75L17.81,9.94l-3.75-3.75L3,17.25z M20.71,7.04c0.39-0.39,0.39-1.02,0-1.41l-2.34-2.34c-0.39-0.39-1.02-0.39-1.41,0l-1.83,1.83l3.75,3.75L20.71,7.04z" Width="14" Height="14"/>
        </Button>

        <!-- Text Tool -->
        <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                        Classes.active="{Binding IsTextToolActive}"
                        Command="{Binding ToggleToolGroupCommand}" CommandParameter="Text"
                        ToolTip.Tip="{Binding [Text], Source={x:Static services:LocalizationService.Instance}}">
            <Button.Flyout>
                <Flyout Placement="Top">
                    <!-- Note: Placement Top for floating windows, might differ for SnipWindow but Top is generally safe or auto-adjusted -->
                    <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="6" CornerRadius="4">
                        <StackPanel Spacing="4" Width="140" TextElement.FontSize="12">
                            <TextBlock Text="{Binding [Font], Source={x:Static services:LocalizationService.Instance}}" FontSize="9" Foreground="Gray"/>
                            
                            <!-- Size & Style Row -->
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <c:CompactNumericStep Value="{Binding CurrentFontSize, Mode=TwoWay}" 
                                                      IncreaseCommand="{Binding IncreaseFontSizeCommand}"
                                                      DecreaseCommand="{Binding DecreaseFontSizeCommand}"
                                                      VerticalAlignment="Center"/>

                                <ToggleButton Theme="{StaticResource SnipToggleButton}" FontSize="12" BorderThickness="1" Content="B" FontWeight="Bold" Width="24" Height="24"
                                              IsChecked="{Binding IsBold}"/>
                                <ToggleButton Theme="{StaticResource SnipToggleButton}" FontSize="12" BorderThickness="1" Content="I" FontStyle="Italic" Width="24" Height="24"
                                              IsChecked="{Binding IsItalic}"/>
                            </StackPanel>
                            
                            <!-- Font Family -->
                            <ComboBox ItemsSource="{Binding AvailableFonts}" 
                                      SelectedItem="{Binding CurrentFontFamily}" 
                                      Height="24" FontSize="10" HorizontalAlignment="Stretch"
                                      MaxDropDownHeight="200"/>
                        </StackPanel>
                    </Border>
                </Flyout>
            </Button.Flyout>
            <PathIcon Data="M5,4v3h5.5v12h3V7H19V4H5z" Width="14" Height="14"/>
        </Button>
        
        <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center"/>

        <!-- Style Button -->
        <Button Theme="{StaticResource SnipButton}" FontSize="12" BorderThickness="1" ToolTip.Tip="{Binding [Color], Source={x:Static services:LocalizationService.Instance}}">
            <Button.Flyout>
                <Flyout Placement="Top">
                    <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="6" CornerRadius="4">
                        <StackPanel Spacing="6" TextElement.FontSize="12">
                            <TextBlock Text="{Binding [Color], Source={x:Static services:LocalizationService.Instance}}" FontSize="9" Foreground="Gray"/>
                            
                            <!-- Custom Color Picker -->
                            <StackPanel Margin="0,4,0,0" Spacing="6">
                                <!-- Preset Colors -->
                                <ItemsControl ItemsSource="{Binding PresetColors}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Columns="5"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button Width="20" Height="20" Margin="2" CornerRadius="10" Padding="0"
                                                    BorderThickness="1" BorderBrush="#555555"
                                                    Command="{Binding $parent[UserControl].DataContext.ChangeColorCommand}"
                                                    CommandParameter="{Binding}">
                                                <Button.Background>
                                                    <SolidColorBrush Color="{Binding}"/>
                                                </Button.Background>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <ColorSpectrum Color="{Binding SelectedColor, Mode=TwoWay}" 
                                               MinWidth="120" MinHeight="120"
                                               Shape="Box"/>
                            </StackPanel>

                            <Separator Background="#333333" Height="1" Margin="0,2"/>
                            
                            <!-- Thickness (Universal) -->
                            <StackPanel IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumNotMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Text}}" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding [Size], Source={x:Static services:LocalizationService.Instance}}" FontSize="9" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                <c:CompactNumericStep Value="{Binding CurrentThickness, Mode=TwoWay}" 
                                                      IncreaseCommand="{Binding IncreaseThicknessCommand}"
                                                      DecreaseCommand="{Binding DecreaseThicknessCommand}"/>
                            </StackPanel>
                            
                            <!-- Font Size (For Text) -->
                            <StackPanel IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Text}}" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding [Size], Source={x:Static services:LocalizationService.Instance}}" FontSize="9" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                <c:CompactNumericStep Value="{Binding CurrentFontSize, Mode=TwoWay}" 
                                                      IncreaseCommand="{Binding IncreaseFontSizeCommand}"
                                                      DecreaseCommand="{Binding DecreaseFontSizeCommand}"/>
                            </StackPanel>

                        </StackPanel>
                    </Border>
                </Flyout>
            </Button.Flyout>
            <Ellipse Width="10" Height="10" Fill="{Binding SelectedColor, Converter={StaticResource ColorToBrushConverter}}"/>
        </Button>
    </StackPanel>
</UserControl>
