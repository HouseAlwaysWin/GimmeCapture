<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:shared="using:GimmeCapture.ViewModels.Shared"
             xmlns:m="using:GimmeCapture.Models"
             xmlns:media="using:Avalonia.Media"
             xmlns:services="using:GimmeCapture.Services.Core"
             xmlns:c="using:GimmeCapture.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="36"
             x:Class="GimmeCapture.Views.Controls.DrawingToolbar"
             x:DataType="shared:IDrawingToolViewModel"
             TextElement.FontSize="12">

    <StackPanel Orientation="Horizontal">
        <!-- Undo / Redo (Unified) -->
        <Button Theme="{StaticResource SnipButton}" FontSize="12" BorderThickness="1" 
                Command="{Binding UndoCommand}" ToolTip.Tip="{Binding UndoTooltip}">
            <PathIcon Data="M12.5,8c-2.65,0-5.05,0.99-6.9,2.6L2,7v9h9l-3.62-3.62c1.39-1.16,3.16-1.88,5.12-1.88c3.54,0,6.55,2.31,7.6,5.5l2.37-0.78C21.08,11.03,17.15,8,12.5,8z" Width="14" Height="14"/>
        </Button>
        <Button Theme="{StaticResource SnipButton}" FontSize="12" BorderThickness="1" 
                Command="{Binding RedoCommand}" ToolTip.Tip="{Binding RedoTooltip}">
            <PathIcon Data="M18.4,10.6C16.55,9,14.15,8,11.5,8c-4.65,0-8.58,3.03-9.96,7.22L3.9,16c1.05-3.19,4.05-5.5,7.6-5.5c1.95,0,3.73,0.72,5.12,1.88L13,16h9V7L18.4,10.6z" Width="14" Height="14"/>
        </Button>

        <Rectangle Fill="#444444" Width="1" Height="20" Margin="4,0" VerticalAlignment="Center"/>

        <!-- Shapes & Lines -->
        <Button x:Name="ShapesButton" Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                        Classes.active="{Binding IsShapeToolActive}"
                        ToolTip.Tip="{Binding [TipShapes], Source={x:Static services:LocalizationService.Instance}}">
            <Button.Flyout>
                <Flyout Placement="Top">
                    <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="2" CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="2" TextElement.FontSize="12">
                            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                                           Classes.active="{Binding CurrentAnnotationTool, ConverterParameter={x:Static m:AnnotationType.Rectangle}, Converter={StaticResource EnumToBoolConverter}}"
                                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Rectangle}" ToolTip.Tip="{Binding RectangleTooltip}"
                                           Click="OnShapeSelected">
                                <PathIcon Data="M19,3H5C3.89,3,3,3.89,3,5v14c0,1.1,0.89,2,2,2h14c1.1,0,2-0.89,2-2V5C21,3.89,20.1,3,19,3z M19,19H5V5h14V19z" Width="14" Height="14"/>
                            </Button>
                            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                                           Classes.active="{Binding CurrentAnnotationTool, ConverterParameter={x:Static m:AnnotationType.Ellipse}, Converter={StaticResource EnumToBoolConverter}}"
                                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Ellipse}" ToolTip.Tip="{Binding EllipseTooltip}"
                                           Click="OnShapeSelected">
                                <PathIcon Data="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8 S16.41,20,12,20z" Width="14" Height="14"/>
                            </Button>
                            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                                           Classes.active="{Binding CurrentAnnotationTool, ConverterParameter={x:Static m:AnnotationType.Arrow}, Converter={StaticResource EnumToBoolConverter}}"
                                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Arrow}" ToolTip.Tip="{Binding ArrowTooltip}"
                                           Click="OnShapeSelected">
                                <PathIcon Data="M9,5v2h6.59L4,18.59L5.41,20L17,8.41V15h2V5H9z" Width="14" Height="14"/>
                            </Button>
                            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                                           Classes.active="{Binding CurrentAnnotationTool, ConverterParameter={x:Static m:AnnotationType.Line}, Converter={StaticResource EnumToBoolConverter}}"
                                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Line}" ToolTip.Tip="{Binding LineTooltip}"
                                           Click="OnShapeSelected">
                                 <PathIcon Data="M3,11h18v2H3V11z" Width="14" Height="14"/>
                             </Button>
                        </StackPanel>
                    </Border>
                </Flyout>
            </Button.Flyout>
            <Panel>
                <TextBlock Text="□" IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Rectangle}}" FontSize="14"/>
                <TextBlock Text="○" IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Ellipse}}" FontSize="14"/>
                <TextBlock Text="↗" IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Arrow}}" FontSize="14"/>
                <TextBlock Text="—" IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Line}}" FontSize="14"/>
                <TextBlock Text="⬚" IsVisible="{Binding IsShapeToolActive, Converter={StaticResource BoolInvertConverter}}" FontSize="14"/>
            </Panel>
        </Button>

        <!-- Pen Tool (Separate) -->
        <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                        Classes.active="{Binding IsPenToolActive}"
                        Command="{Binding ToggleToolGroupCommand}" CommandParameter="Pen"
                        ToolTip.Tip="{Binding PenTooltip}">
             <PathIcon Data="M3,17.25V21h3.75L17.81,9.94l-3.75-3.75L3,17.25z M20.71,7.04c0.39-0.39,0.39-1.02,0-1.41l-2.34-2.34c-0.39-0.39-1.02-0.39-1.41,0l-1.83,1.83l3.75,3.75L20.71,7.04z" Width="14" Height="14"/>
        </Button>

        <!-- Text Tool -->
        <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" 
                        Classes.active="{Binding IsTextToolActive}"
                        Command="{Binding ToggleToolGroupCommand}" CommandParameter="Text"
                        ToolTip.Tip="{Binding TextTooltip}">
            <Button.Flyout>
                <Flyout Placement="Top">
                    <!-- Note: Placement Top for floating windows, might differ for SnipWindow but Top is generally safe or auto-adjusted -->
                    <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="6" CornerRadius="4">
                        <StackPanel Spacing="4" Width="140" TextElement.FontSize="12">
                            <TextBlock Text="{Binding [Font], Source={x:Static services:LocalizationService.Instance}}" FontSize="9" Foreground="Gray"/>
                            
                            <!-- Size & Style Row -->
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <c:CompactNumericStep Value="{Binding CurrentFontSize, Mode=TwoWay}" 
                                                      IncreaseCommand="{Binding IncreaseFontSizeCommand}"
                                                      DecreaseCommand="{Binding DecreaseFontSizeCommand}"
                                                      VerticalAlignment="Center"/>

                                <ToggleButton Theme="{StaticResource SnipToggleButton}" FontSize="12" BorderThickness="1" Content="B" FontWeight="Bold" Width="24" Height="24"
                                              IsChecked="{Binding IsBold}"/>
                                <ToggleButton Theme="{StaticResource SnipToggleButton}" FontSize="12" BorderThickness="1" Content="I" FontStyle="Italic" Width="24" Height="24"
                                              IsChecked="{Binding IsItalic}"/>
                            </StackPanel>
                            
                            <!-- Font Family -->
                            <ComboBox ItemsSource="{Binding AvailableFonts}" 
                                      SelectedItem="{Binding CurrentFontFamily}" 
                                      Height="24" FontSize="10" HorizontalAlignment="Stretch"
                                      MaxDropDownHeight="200"/>
                        </StackPanel>
                    </Border>
                </Flyout>
            </Button.Flyout>
            <PathIcon Data="M5,4v3h5.5v12h3V7H19V4H5z" Width="14" Height="14"/>
        </Button>
        
        <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center"/>

        <!-- Style Button -->
        <Button Theme="{StaticResource SnipButton}" FontSize="12" BorderThickness="1" ToolTip.Tip="{Binding [Color], Source={x:Static services:LocalizationService.Instance}}">
            <Button.Flyout>
                <Flyout Placement="Top">
                    <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="6" CornerRadius="4">
                        <StackPanel Spacing="6" TextElement.FontSize="12">
                            <TextBlock Text="{Binding [Color], Source={x:Static services:LocalizationService.Instance}}" FontSize="9" Foreground="Gray"/>
                            
                            <!-- Custom Color Picker -->
                            <StackPanel Margin="0,4,0,0" Spacing="6">
                                <!-- Preset Colors -->
                                <ItemsControl ItemsSource="{Binding PresetColors}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Columns="5"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button Width="20" Height="20" Margin="2" CornerRadius="10" Padding="0"
                                                    BorderThickness="1" BorderBrush="#555555"
                                                    Command="{Binding $parent[UserControl].DataContext.ChangeColorCommand}"
                                                    CommandParameter="{Binding}">
                                                <Button.Background>
                                                    <SolidColorBrush Color="{Binding}"/>
                                                </Button.Background>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <ColorSpectrum Color="{Binding SelectedColor, Mode=TwoWay}" 
                                               MinWidth="120" MinHeight="120"
                                               Shape="Box"/>
                            </StackPanel>

                            <Separator Background="#333333" Height="1" Margin="0,2"/>
                            
                            <!-- Thickness (Universal) -->
                            <StackPanel IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumNotMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Text}}" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding [Size], Source={x:Static services:LocalizationService.Instance}}" FontSize="9" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                <c:CompactNumericStep Value="{Binding CurrentThickness, Mode=TwoWay}" 
                                                      IncreaseCommand="{Binding IncreaseThicknessCommand}"
                                                      DecreaseCommand="{Binding DecreaseThicknessCommand}"/>
                            </StackPanel>
                            
                            <!-- Font Size (For Text) -->
                            <StackPanel IsVisible="{Binding CurrentAnnotationTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Text}}" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding [Size], Source={x:Static services:LocalizationService.Instance}}" FontSize="9" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                <c:CompactNumericStep Value="{Binding CurrentFontSize, Mode=TwoWay}" 
                                                      IncreaseCommand="{Binding IncreaseFontSizeCommand}"
                                                      DecreaseCommand="{Binding DecreaseFontSizeCommand}"/>
                            </StackPanel>

                        </StackPanel>
                    </Border>
                </Flyout>
            </Button.Flyout>
            <PathIcon Data="M12,2C6.49,2 2,6.49 2,12C2,17.51 6.49,22 12,22C13.91,22 15.46,20.45 15.46,18.54C15.46,18.11 15.37,17.7 15.22,17.33C15.07,16.96 15,16.57 15,16.15C15,14.97 15.97,14 17.15,14H19C20.65,14 22,12.65 22,11C22,6.04 17.51,2 12,2M5.5,13A1.5,1.5 0 0,1 4,11.5A1.5,1.5 0 0,1 5.5,10A1.5,1.5 0 0,1 7,11.5A1.5,1.5 0 0,1 5.5,13M7.5,8A1.5,1.5 0 0,1 6,6.5A1.5,1.5 0 0,1 7.5,5A1.5,1.5 0 0,1 9,6.5A1.5,1.5 0 0,1 7.5,8M12.5,7A1.5,1.5 0 0,1 11,5.5A1.5,1.5 0 0,1 12.5,4A1.5,1.5 0 0,1 14,5.5A1.5,1.5 0 0,1 12.5,7M16.5,10A1.5,1.5 0 0,1 15,8.5A1.5,1.5 0 0,1 16.5,7A1.5,1.5 0 0,1 18,8.5A1.5,1.5 0 0,1 16.5,10Z" 
                      Width="14" Height="14"
                      Foreground="{Binding SelectedColor, Converter={StaticResource ColorToBrushConverter}}"/>
        </Button>
    </StackPanel>
</UserControl>
