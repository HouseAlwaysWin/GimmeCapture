<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:GimmeCapture.ViewModels"
             xmlns:m="using:GimmeCapture.Models"
             xmlns:media="using:Avalonia.Media"
             mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="36"
             x:Class="GimmeCapture.Views.Controls.SnipToolbar"
             x:DataType="vm:SnipWindowViewModel">

    <Border Background="#1A1A1A" 
            BorderBrush="#333333" 
            BorderThickness="1" 
            CornerRadius="4" 
            BoxShadow="0 2 8 0 #A0000000"
            Padding="2">
        <StackPanel Orientation="Horizontal" Spacing="2">
            <!-- Main Actions -->
            <Button Theme="{StaticResource SnipButton}" Content="Copy" Command="{Binding CopyCommand}" ToolTip.Tip="Copy (Ctrl+C)"/>
            <Button Theme="{StaticResource SnipButton}" Content="Save" Command="{Binding SaveCommand}" ToolTip.Tip="Save (Ctrl+S)"/>
            <Button Theme="{StaticResource SnipButton}" Content="Pin" Command="{Binding PinCommand}" ToolTip.Tip="Pin (F3)"/>
            
            <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center"/>
            
            <!-- Grouped Annotation Tools -->
            <Button Theme="{StaticResource SnipButton}" ToolTip.Tip="Shapes">
                <Button.Flyout>
                    <Flyout Placement="Bottom">
                        <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="2" CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Spacing="2">
                                <ToggleButton Theme="{StaticResource SnipToggleButton}" Content="â–¡" 
                                               IsChecked="{Binding CurrentTool, ConverterParameter={x:Static m:AnnotationType.Rectangle}, Converter={StaticResource EnumToBoolConverter}}"
                                               Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Rectangle}"/>
                                <ToggleButton Theme="{StaticResource SnipToggleButton}" Content="â—‹" 
                                               IsChecked="{Binding CurrentTool, ConverterParameter={x:Static m:AnnotationType.Ellipse}, Converter={StaticResource EnumToBoolConverter}}"
                                               Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Ellipse}"/>
                            </StackPanel>
                        </Border>
                    </Flyout>
                </Button.Flyout>
                <Panel>
                    <TextBlock Text="â–¡" IsVisible="{Binding CurrentTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Rectangle}}"/>
                    <TextBlock Text="â—‹" IsVisible="{Binding CurrentTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Ellipse}}"/>
                    <TextBlock Text="â¬š" IsVisible="{Binding IsShapeToolActive, Converter={StaticResource BoolInvertConverter}}"/>
                </Panel>
            </Button>

            <Button Theme="{StaticResource SnipButton}" ToolTip.Tip="Lines &amp; Arrows">
                <Button.Flyout>
                    <Flyout Placement="Bottom">
                        <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="2" CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Spacing="2">
                                <ToggleButton Theme="{StaticResource SnipToggleButton}" Content="â†—" 
                                               IsChecked="{Binding CurrentTool, ConverterParameter={x:Static m:AnnotationType.Arrow}, Converter={StaticResource EnumToBoolConverter}}"
                                               Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Arrow}"/>
                                <ToggleButton Theme="{StaticResource SnipToggleButton}" Content="â€”" 
                                               IsChecked="{Binding CurrentTool, ConverterParameter={x:Static m:AnnotationType.Line}, Converter={StaticResource EnumToBoolConverter}}"
                                               Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Line}"/>
                            </StackPanel>
                        </Border>
                    </Flyout>
                </Button.Flyout>
                <Panel>
                    <TextBlock Text="â†—" IsVisible="{Binding CurrentTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Arrow}}"/>
                    <TextBlock Text="â€”" IsVisible="{Binding CurrentTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Line}}"/>
                    <TextBlock Text="â†—" IsVisible="{Binding IsLineToolActive, Converter={StaticResource BoolInvertConverter}}"/>
                </Panel>
            </Button>

            <ToggleButton Theme="{StaticResource SnipToggleButton}" Content="T" 
                           IsChecked="{Binding CurrentTool, ConverterParameter={x:Static m:AnnotationType.Text}, Converter={StaticResource EnumToBoolConverter}}"
                           Command="{Binding SelectToolCommand}" CommandParameter="{x:Static m:AnnotationType.Text}"
                           ToolTip.Tip="Text (T)"/>
            
            <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center"/>

            <!-- Style Button -->
            <Button Theme="{StaticResource SnipButton}" ToolTip.Tip="Style">
                <Button.Flyout>
                    <Flyout Placement="Bottom">
                        <Border Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" Padding="6" CornerRadius="4">
                            <StackPanel Spacing="6">
                                <TextBlock Text="Color" FontSize="9" Foreground="Gray"/>
                                <ItemsControl ItemsSource="{x:Static vm:SnipWindowViewModel+StaticData.ColorsList}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Width="88"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="media:Color">
                                            <Button Width="16" Height="16" Margin="1" Padding="0" CornerRadius="8"
                                                    Background="{Binding Converter={StaticResource ColorToBrushConverter}}"
                                                    Command="{Binding $parent[UserControl].((vm:SnipWindowViewModel)DataContext).ChangeColorCommand}"
                                                    CommandParameter="{Binding}">
                                                <Border BorderBrush="White" BorderThickness="1" CornerRadius="8" IsHitTestVisible="False"
                                                        IsVisible="{Binding $parent[UserControl].((vm:SnipWindowViewModel)DataContext).SelectedColor, Converter={StaticResource ColorMatchConverter}, ConverterParameter={Binding}}"/>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <!-- Custom Color Picker -->
                                <StackPanel Margin="0,4,0,0">
                                    <TextBlock Text="Custom" FontSize="9" Foreground="Gray"/>
                                    <ColorSpectrum Color="{Binding SelectedColor, Mode=TwoWay}" 
                                                   MinWidth="80" MinHeight="80"
                                                   MaxWidth="80" MaxHeight="80"
                                                   Shape="Box"/>
                                </StackPanel>

                                <Separator Background="#333333" Height="1" Margin="0,2"/>
                                
                                <StackPanel IsVisible="{Binding CurrentTool, Converter={StaticResource EnumNotMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Text}}">
                                    <TextBlock Text="Size" FontSize="9" Foreground="Gray"/>
                                    <StackPanel Orientation="Horizontal" Spacing="1">
                                        <TextBox Text="{Binding CurrentThickness}" Width="1" Height="1" FontSize="20" 
                                                 Background="#2A2A2A" Foreground="White" BorderBrush="#444444" Padding="2,0"/>
                                        <StackPanel Spacing="0">
                                            <RepeatButton Content="â–²" Width="15" Height="15" FontSize="7" Padding="0"
                                                          Command="{Binding IncreaseThicknessCommand}"/>
                                            <RepeatButton Content="â–¼" Width="15" Height="15" FontSize="7" Padding="0"
                                                          Command="{Binding DecreaseThicknessCommand}"/>
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                                
                                <StackPanel IsVisible="{Binding CurrentTool, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static m:AnnotationType.Text}}">
                                    <TextBlock Text="Font" FontSize="9" Foreground="Gray"/>
                                    <StackPanel Orientation="Horizontal" Spacing="1">
                                        <TextBox Text="{Binding CurrentFontSize}" Width="1" Height="1" FontSize="20" 
                                                 Background="#2A2A2A" Foreground="White" BorderBrush="#444444" Padding="2,0"/>
                                        <StackPanel Spacing="0">
                                            <RepeatButton Content="â–²" Width="15" Height="15" FontSize="7" Padding="0"
                                                          Command="{Binding IncreaseFontSizeCommand}"/>
                                            <RepeatButton Content="â–¼" Width="15" Height="15" FontSize="7" Padding="0"
                                                          Command="{Binding DecreaseFontSizeCommand}"/>
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </Flyout>
                </Button.Flyout>
                <Ellipse Width="10" Height="10" Fill="{Binding SelectedColor, Converter={StaticResource ColorToBrushConverter}}"/>
            </Button>

            <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center"/>
            
            <Button Theme="{StaticResource SnipButton}" Content="â†©" Command="{Binding UndoCommand}" ToolTip.Tip="Undo (Ctrl+Z)"/>
            <Button Theme="{StaticResource SnipButton}" Content="ðŸ—‘" Command="{Binding ClearCommand}" ToolTip.Tip="Clear All"/>
        </StackPanel>
    </Border>
</UserControl>
