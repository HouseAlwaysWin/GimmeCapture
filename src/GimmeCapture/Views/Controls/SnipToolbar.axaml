<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:GimmeCapture.ViewModels.Main"
             xmlns:m="using:GimmeCapture.Models"
             xmlns:services="using:GimmeCapture.Services.Core"
             xmlns:media="using:Avalonia.Media"
             xmlns:c="using:GimmeCapture.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="36"
             x:Class="GimmeCapture.Views.Controls.SnipToolbar"
             x:DataType="vm:SnipWindowViewModel"
             TextElement.FontSize="12">

    <Border Background="#1A1A1A" 
            BorderBrush="#333333" 
            BorderThickness="1" 
            CornerRadius="4" 
            Padding="2">
        <WrapPanel Orientation="Horizontal">
            <WrapPanel.Styles>
                <Style Selector="Button, Rectangle, c|DrawingToolbar">
                    <Setter Property="Margin" Value="1,2"/>
                </Style>
            </WrapPanel.Styles>
            <!-- 1. Mode Selection Buttons -->
            <Button Theme="{StaticResource SnipToolButton}" Classes.active="{Binding !IsRecordingMode}" 
                    Command="{Binding SetCaptureModeCommand}" CommandParameter="{x:False}"
                    ToolTip.Tip="{Binding SnipTooltip}">
                <PathIcon Data="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" Width="14" Height="14"/>
            </Button>
            <Button Theme="{StaticResource SnipToolButton}" Classes.active="{Binding IsRecordingMode}" 
                    Command="{Binding SetCaptureModeCommand}" CommandParameter="{x:True}"
                    ToolTip.Tip="{Binding RecordTooltip}">
                <PathIcon Data="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 16,17V13.5L21,17.5V6.5L17,10.5Z" Width="14" Height="14"/>
            </Button>

            <Rectangle Fill="#444444" Width="1" Height="16" Margin="4,0" VerticalAlignment="Center"/>

            <!-- 2. Annotation Tools (Shared) - Spread out in the same WrapPanel -->
            <c:DrawingToolbar DataContext="{Binding}"/>

            <!-- 3. Record Mode Unique Actions -->
            <Rectangle Fill="#444444" Width="1" Height="16" Margin="4,0" VerticalAlignment="Center" IsVisible="{Binding IsRecordingMode}"/>

            <!-- Record Buttons -->
            <Button Theme="{StaticResource SnipButton}" Width="32" BorderThickness="1" 
                    Command="{Binding StartRecordingCommand}" 
                    ToolTip.Tip="{Binding RecordTooltip}">
                <Button.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="IsRecordingMode"/>
                        <Binding Path="RecState" Converter="{StaticResource EnumMatchConverter}" ConverterParameter="{x:Static services:RecordingState.Idle}"/>
                    </MultiBinding>
                </Button.IsVisible>
                <Ellipse Fill="#E60012" Width="12" Height="12"/>
            </Button>
            
            <Button Theme="{StaticResource SnipButton}" Width="32" BorderThickness="1" 
                    Command="{Binding PauseRecordingCommand}" 
                    ToolTip.Tip="{Binding [Pause], Source={x:Static services:LocalizationService.Instance}}">
                 <Button.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="IsRecordingMode"/>
                        <Binding Path="RecState" Converter="{StaticResource EnumNotMatchConverter}" ConverterParameter="{x:Static services:RecordingState.Idle}"/>
                    </MultiBinding>
                </Button.IsVisible>
                <Panel>
                    <PathIcon Data="M14,19H18V5H14M6,19H10V5H6V19Z" Width="14" Height="14" 
                                IsVisible="{Binding RecState, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static services:RecordingState.Recording}}"/>
                    <PathIcon Data="M8,5.14V19.14L19,12.14L8,5.14Z" Width="14" Height="14" 
                                IsVisible="{Binding RecState, Converter={StaticResource EnumMatchConverter}, ConverterParameter={x:Static services:RecordingState.Paused}}"/>
                </Panel>
            </Button>

            <Button Theme="{StaticResource SnipButton}" Width="32" BorderThickness="1" 
                    Command="{Binding StopRecordingCommand}" 
                    IsEnabled="{Binding RecState, Converter={StaticResource EnumNotMatchConverter}, ConverterParameter={x:Static services:RecordingState.Idle}}"
                    IsVisible="{Binding IsRecordingMode}"
                    ToolTip.Tip="{Binding [Stop], Source={x:Static services:LocalizationService.Instance}}">
                <Rectangle Fill="White" Width="10" Height="10"/>
            </Button>

            <TextBlock Text="{Binding RecordingDurationText}" VerticalAlignment="Center" Margin="4,0" Foreground="White" FontSize="11" FontFamily="Consolas"
                       IsVisible="{Binding IsRecordingMode}"/>
            
            <Rectangle Fill="#444444" Width="1" Height="16" Margin="4,0" VerticalAlignment="Center"/>

            <!-- 4. Clear -->
            <Button Theme="{StaticResource SnipToolButton}" FontSize="12" BorderThickness="1" Command="{Binding ClearAnnotationsCommand}" ToolTip.Tip="{Binding ClearTooltip}">
                <PathIcon Data="M19,4h-3.5l-1-1h-5l-1,1H5v2h14V4z M6,19c0,1.1,0.9,2,2,2h8c1.1,0,2-0.9,2-2V7H6V19z" Width="14" Height="14"/>
            </Button>

            <Rectangle Fill="#444444" Width="1" Height="16" Margin="4,0" VerticalAlignment="Center"/>

            <!-- 5. Core Actions (Shared) -->
            <Button Theme="{StaticResource SnipButton}" FontSize="12" BorderThickness="1" Command="{Binding CopyCommand}" ToolTip.Tip="{Binding CopyTooltip}">
                <PathIcon Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" Width="14" Height="14"/>
            </Button>
            <Button Theme="{StaticResource SnipButton}" FontSize="12" BorderThickness="1" Command="{Binding SaveCommand}" ToolTip.Tip="{Binding SaveTooltip}">
                <PathIcon Data="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" Width="14" Height="14"/>
            </Button>
            <Button Theme="{StaticResource SnipButton}" FontSize="12" BorderThickness="1" Command="{Binding PinCommand}" ToolTip.Tip="{Binding PinTooltip}">
                <PathIcon Data="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" Width="14" Height="14"/>
            </Button>
            <Button Theme="{StaticResource SnipToolButton}" 
                    Classes.active="{Binding IsTranslationActive}"
                    Command="{Binding TranslateCommand}"
                    IsVisible="{Binding !IsRecordingMode}"
                    ToolTip.Tip="即時翻譯 (Ollama)">
                <PathIcon Data="M12.87,15.07L10.33,12.56L10.36,12.53C12.1,10.59 13.34,8.36 14.07,6H17V4H10V2H8V4H1V6H12.17C11.5,7.92 10.44,9.75 9,11.35C8.07,10.32 7.3,9.19 6.69,8H4.69C5.42,9.63 6.42,11.17 7.67,12.56L2.58,17.58L4,19L9,14L12.11,17.11L12.87,15.07M18.5,10H16.5L12,22H14L15.12,19H19.87L21,22H23L18.5,10M15.88,17L17.5,12.67L19.12,17H15.88Z" Width="14" Height="14"/>
            </Button>

            <!-- 6. Integrated Loading Indicator -->
            <StackPanel Orientation="Horizontal" IsVisible="{Binding ShowSnipToolBar}" VerticalAlignment="Center" Margin="4,0">
                <Rectangle Fill="#444444" Width="1" Height="16" Margin="0,0,4,0"/>
                <StackPanel Spacing="2">
                    <TextBlock Text="{Binding ProcessingText}" Foreground="White" FontSize="10" HorizontalAlignment="Center"/>
                    <ProgressBar IsIndeterminate="{Binding IsIndeterminate}"
                                 Value="{Binding ProgressValue}"
                                 Minimum="0" Maximum="100"
                                 Height="3" MinWidth="60"
                                 Foreground="{DynamicResource ThemeAccentBrush}"
                                 Background="#333333"/>
                </StackPanel>
            </StackPanel>

        </WrapPanel>
    </Border>
</UserControl>
