<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:GimmeCapture.ViewModels.Main"
        xmlns:cv="using:GimmeCapture.Converters"
        xmlns:ctl="using:GimmeCapture.Views.Controls"
        xmlns:m="using:GimmeCapture.Models"
        xmlns:services="using:GimmeCapture.Services.Core"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="GimmeCapture.Views.Main.SnipWindow"
        x:DataType="vm:SnipWindowViewModel"
        Title="SnipWindow"
        TransparencyLevelHint="Transparent"
        SystemDecorations="None"
        WindowState="Normal"
        Topmost="True"
        Background="Transparent"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ClipToBounds="False"
        FontFamily="{Binding CurrentFontFamily, Source={x:Static services:LocalizationService.Instance}}">

    <Window.Resources>
        <cv:DoubleToBoolConverter x:Key="SizeToBoolConverter"/>
        <cv:StateToBoolConverter x:Key="StateToBoolConverter"/>
        <cv:BoolToFontWeightConverter x:Key="BoolToFontWeightConverter"/>
        <cv:BoolToFontStyleConverter x:Key="BoolToFontStyleConverter"/>
    </Window.Resources>
    
    <Window.KeyBindings>
        <KeyBinding Gesture="Ctrl+C" Command="{Binding CopyCommand}" />
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveCommand}" />
        <KeyBinding Gesture="F3" Command="{Binding PinCommand}" />
    </Window.KeyBindings>

    <Window.Styles>
        <Style Selector="Grid.Handle">
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <Style Selector="Border.StatusBar">
            <Setter Property="Background" Value="#F2121212"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Bottom"/>
            <Setter Property="Margin" Value="0,0,0,80"/>
            <Setter Property="IsHitTestVisible" Value="False"/>
            <Setter Property="Opacity" Value="0"/>
            <Setter Property="IsVisible" Value="False"/>
            <Setter Property="RenderTransform" Value="translateY(20px)"/>
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.3"/>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Border.StatusBar.active">
            <Setter Property="IsVisible" Value="True"/>
            <Setter Property="Opacity" Value="1"/>
            <Setter Property="RenderTransform" Value="translateY(0px)"/>
        </Style>
    </Window.Styles>
    
    <Grid>
        <!-- 背景遮罩層 -->
        <Path Fill="Black" Data="{Binding MaskGeometry}" Opacity="{Binding MaskOpacity}" IsHitTestVisible="False"/>
        
            <!-- AI Scan Results Layer (Background Candidates) -->
            <ItemsControl ItemsSource="{Binding WindowRects}" IsHitTestVisible="True"
                          Width="{Binding ViewportSize.Width}" Height="{Binding ViewportSize.Height}">
                <ItemsControl.IsVisible>
                    <Binding Path="CurrentState">
                        <Binding.Converter>
                            <cv:EnumMatchConverter/>
                        </Binding.Converter>
                        <Binding.ConverterParameter>
                            <x:Static Member="vm:SnipState.Detecting"/>
                        </Binding.ConverterParameter>
                    </Binding>
                </ItemsControl.IsVisible>
                <ItemsControl.Styles>
                    <Style Selector="ItemsControl > ContentPresenter" x:DataType="m:VisualRect">
                        <Setter Property="Canvas.Left" Value="{Binding X}"/>
                        <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                    </Style>
                </ItemsControl.Styles>
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <!-- Interactive Candidate Box -->
                        <Border BorderBrush="#40FF0000" 
                                BorderThickness="1"
                                Background="Transparent"
                                Width="{Binding Width}"
                                Height="{Binding Height}">
                            <Border.Styles>
                                <Style Selector="Border:pointerover">
                                    <Setter Property="BorderBrush" Value="#FFFF0000"/>
                                    <Setter Property="BorderThickness" Value="3"/>
                                    <Setter Property="Background" Value="#10FF0000"/>
                                </Style>
                            </Border.Styles>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Detection Preview Layer (Active Selection - Dashed) -->
            <Canvas IsHitTestVisible="False">
                <Rectangle Stroke="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}"
                           StrokeThickness="2"
                           StrokeDashArray="4,2"
                           IsVisible="{Binding !!DetectedRect.Width}"
                           Width="{Binding DetectedRect.Width}"
                           Height="{Binding DetectedRect.Height}"
                           Canvas.Left="{Binding DetectedRect.X}"
                           Canvas.Top="{Binding DetectedRect.Y}">
                    <Rectangle.Opacity>
                        <Binding Path="CurrentState">
                            <Binding.Converter>
                                <cv:EnumMatchConverter/>
                            </Binding.Converter>
                            <Binding.ConverterParameter>
                                <x:Static Member="vm:SnipState.Detecting"/>
                            </Binding.ConverterParameter>
                        </Binding>
                    </Rectangle.Opacity>
                </Rectangle>
            </Canvas>

        
        <!-- Annotation Layer -->
        <Canvas IsHitTestVisible="False">
            <Panel Width="{Binding SelectionRect.Width}"
                   Height="{Binding SelectionRect.Height}"
                   Canvas.Left="{Binding SelectionRect.X}"
                   Canvas.Top="{Binding SelectionRect.Y}">
                
                <!-- Checkerboard Background for Transparency Visualization -->
                <Border IsVisible="{Binding !!DrawingModeSnapshot}" IsHitTestVisible="False">
                    <Border.Background>
                        <VisualBrush TileMode="Tile" Stretch="None" SourceRect="0,0,10,10" DestinationRect="0,0,10,10">
                            <VisualBrush.Visual>
                                <Canvas Width="10" Height="10" Background="White">
                                    <Rectangle Width="5" Height="5" Fill="#CCCCCC" />
                                    <Rectangle Canvas.Left="5" Canvas.Top="5" Width="5" Height="5" Fill="#CCCCCC" />
                                </Canvas>
                            </VisualBrush.Visual>
                        </VisualBrush>
                    </Border.Background>
                </Border>

                <Image Source="{Binding DrawingModeSnapshot}"
                       Stretch="Fill"
                       IsVisible="{Binding !!DrawingModeSnapshot}"
                       IsHitTestVisible="False"/>

                <ItemsControl ItemsSource="{Binding Annotations}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas Width="{Binding SelectionRect.Width}" Height="{Binding SelectionRect.Height}"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="m:Annotation">
                            <ctl:AnnotationControl Annotation="{Binding}" 
                                                   Width="{Binding $parent[Window].((vm:SnipWindowViewModel)DataContext).SelectionRect.Width}"
                                                   Height="{Binding $parent[Window].((vm:SnipWindowViewModel)DataContext).SelectionRect.Height}"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Panel>
        </Canvas>

        <!-- 互動層 -->
        <Canvas>
            <Grid Width="{Binding SelectionRect.Width}"
                  Height="{Binding SelectionRect.Height}"
                  Canvas.Left="{Binding SelectionRect.X}"
                  Canvas.Top="{Binding SelectionRect.Y}"
                  IsVisible="{Binding CurrentState, Converter={StaticResource StateToBoolConverter}}"
                  ClipToBounds="False">
                  
                <!-- Selection Border -->
                <Border CornerRadius="0" Background="#01FFFFFF"
                        BoxShadow="{Binding SelectionBorderColor, Converter={StaticResource ColorToBoxShadowConverter}}"
                        IsVisible="{Binding HideFrameBorder, Converter={StaticResource BoolInvertConverter}}"
                        IsHitTestVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"
                        Opacity="{Binding IsRecordingActive, Converter={StaticResource BoolInvertConverter}}">
                    <Border.BorderBrush>
                        <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                            <GradientStop Offset="0" Color="{Binding SelectionBorderColor}"/>
                            <GradientStop Offset="1" Color="{Binding SelectionBorderColor}"/>
                        </LinearGradientBrush>
                    </Border.BorderBrush>
                    <Border BorderBrush="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}" 
                            BorderThickness="{Binding SelectionBorderThickness, Converter={StaticResource ThicknessConverter}}">
                        <Border BorderBrush="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}" BorderThickness="1" Margin="-1" />
                    </Border>
                </Border>
                
                <!-- Resize Handles -->
                <Grid Classes="Handle" Name="HandleTopLeft" Cursor="TopLeftCorner" Width="30" Height="30" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="-15" 
                      IsVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"/>
                <Grid Classes="Handle" Name="HandleTopRight" Cursor="TopRightCorner" Width="30" Height="30" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="-15"
                      IsVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"/>
                <Grid Classes="Handle" Name="HandleBottomLeft" Cursor="BottomLeftCorner" Width="30" Height="30" HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="-15"
                      IsVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"/>
                <Grid Classes="Handle" Name="HandleBottomRight" Cursor="BottomRightCorner" Width="30" Height="30" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="-15"
                      IsVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"/>
                <Grid Classes="Handle" Name="HandleTop" Cursor="SizeNorthSouth" Height="15" HorizontalAlignment="Stretch" VerticalAlignment="Top" Margin="15,0"
                      IsVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"/>
                <Grid Classes="Handle" Name="HandleBottom" Cursor="SizeNorthSouth" Height="15" HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Margin="15,0"
                      IsVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"/>
                <Grid Classes="Handle" Name="HandleLeft" Cursor="SizeWestEast" Width="15" HorizontalAlignment="Left" VerticalAlignment="Stretch" Margin="0,15"
                      IsVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"/>
                <Grid Classes="Handle" Name="HandleRight" Cursor="SizeWestEast" Width="15" HorizontalAlignment="Right" VerticalAlignment="Stretch" Margin="0,15"
                      IsVisible="{Binding IsDrawingMode, Converter={StaticResource BoolInvertConverter}}"/>

                <!-- Move Handles -->
                <Grid IsVisible="{Binding IsRecordingActive, Converter={StaticResource BoolInvertConverter}}" ClipToBounds="False">
                    <Grid IsVisible="{Binding HideSelectionDecoration, Converter={StaticResource BoolInvertConverter}}" ClipToBounds="False">
                        <Border BorderThickness="{Binding SelectionBorderThickness, Converter={StaticResource ThicknessConverter}}" ClipToBounds="False">
                            <Border BorderThickness="1" Margin="-1" ClipToBounds="False">
                                <Grid Name="AccentCornersGrid" ClipToBounds="False">
                                    <Rectangle Name="InnerCornerTopLeft" Classes="MoveHandle" Width="{Binding SelectionIconSize}" Height="{Binding SelectionIconSize}" VerticalAlignment="Top" HorizontalAlignment="Left" Margin="4"
                                               Fill="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                               RenderOptions.BitmapInterpolationMode="HighQuality">
                                        <Rectangle.OpacityMask><ImageBrush Source="avares://GimmeCapture/Assets/heart.png" Stretch="Uniform"/></Rectangle.OpacityMask>
                                    </Rectangle>
                                    <Rectangle Name="InnerCornerBottomLeft" Classes="MoveHandle" Width="{Binding SelectionIconSize}" Height="{Binding SelectionIconSize}" VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="4"
                                               Fill="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                               RenderOptions.BitmapInterpolationMode="HighQuality">
                                        <Rectangle.OpacityMask><ImageBrush Source="avares://GimmeCapture/Assets/heart.png" Stretch="Uniform"/></Rectangle.OpacityMask>
                                    </Rectangle>
                                    <Rectangle Name="InnerCornerTopRight" Classes="MoveHandle" Width="{Binding SelectionIconSize}" Height="{Binding SelectionIconSize}" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="4"
                                               Fill="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                               RenderOptions.BitmapInterpolationMode="HighQuality">
                                        <Rectangle.OpacityMask><ImageBrush Source="avares://GimmeCapture/Assets/skull.png" Stretch="Uniform"/></Rectangle.OpacityMask>
                                    </Rectangle>
                                    <Rectangle Name="InnerCornerBottomRight" Classes="MoveHandle" Width="{Binding SelectionIconSize}" Height="{Binding SelectionIconSize}" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="4"
                                               Fill="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                               RenderOptions.BitmapInterpolationMode="HighQuality">
                                        <Rectangle.OpacityMask><ImageBrush Source="avares://GimmeCapture/Assets/skull.png" Stretch="Uniform"/></Rectangle.OpacityMask>
                                    </Rectangle>
                                </Grid>
                            </Border>
                        </Border>
                    </Grid>
                </Grid>
                
                <!-- Wings -->
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ClipToBounds="False" IsHitTestVisible="False">
                    <Grid.IsVisible>
                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                             <Binding Path="IsRecordingActive" Converter="{StaticResource BoolInvertConverter}"/>
                             <Binding Path="HideSelectionDecoration" Converter="{StaticResource BoolInvertConverter}"/>
                        </MultiBinding>
                    </Grid.IsVisible>
                    <Rectangle Width="{Binding WingWidth}" Height="{Binding WingHeight}" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="{Binding LeftWingMargin}"
                               Fill="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}" RenderOptions.BitmapInterpolationMode="HighQuality">
                        <Rectangle.OpacityMask><ImageBrush Source="avares://GimmeCapture/Assets/wing_left.png" Stretch="Uniform" AlignmentX="Right"/></Rectangle.OpacityMask>
                    </Rectangle>
                    <Rectangle Width="{Binding WingWidth}" Height="{Binding WingHeight}" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="{Binding RightWingMargin}"
                               Fill="{Binding SelectionBorderColor, Converter={StaticResource ColorToBrushConverter}}" RenderOptions.BitmapInterpolationMode="HighQuality">
                        <Rectangle.OpacityMask><ImageBrush Source="avares://GimmeCapture/Assets/wing_right.png" Stretch="Uniform" AlignmentX="Left"/></Rectangle.OpacityMask>
                    </Rectangle>
                </Grid>
            </Grid>
            
            <!-- Text Overlay -->
            <!-- Text Input Overlay -->
            <ctl:TextEntryOverlay DataContext="{Binding}"
                                  Canvas.Left="{Binding TextInputPosition.X}"
                                  Canvas.Top="{Binding TextInputPosition.Y}"/>
                    <ctl:SnipToolbar Name="Toolbar" Canvas.Left="{Binding ToolbarLeft}" Canvas.Top="{Binding ToolbarTop}" 
                                     MaxWidth="{Binding ToolbarMaxWidth}"
                                     IsVisible="{Binding CurrentState, Converter={StaticResource StateToBoolConverter}}"/>
        </Canvas>
        
        <!-- Processing Overlay - centered on the ACTIVE MONITOR -->
        <Canvas IsHitTestVisible="False" ZIndex="999">
             <Grid Width="{Binding ActiveScreenBounds.Width}" 
                   Height="{Binding ActiveScreenBounds.Height}" 
                   Canvas.Left="{Binding ActiveScreenBounds.X}" 
                   Canvas.Top="{Binding ActiveScreenBounds.Y}"
                   IsVisible="{Binding IsProcessing}">
                 <ctl:ProcessingOverlay DataContext="{Binding}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
             </Grid>
        </Canvas>
    </Grid>
</Window>
