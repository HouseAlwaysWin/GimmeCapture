<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:GimmeCapture.ViewModels"
        xmlns:cv="using:GimmeCapture.Converters"
        xmlns:ctl="using:GimmeCapture.Views.Controls"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="GimmeCapture.Views.SnipWindow"
        x:DataType="vm:SnipWindowViewModel"
        Title="SnipWindow"
        TransparencyLevelHint="Transparent"
        SystemDecorations="None"
        WindowState="Maximized"
        Topmost="True"
        Cursor="Cross"
        Background="Transparent"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome">

    <Window.Resources>
        <cv:DoubleToBoolConverter x:Key="SizeToBoolConverter"/>
        <cv:StateToBoolConverter x:Key="StateToBoolConverter"/>
    </Window.Resources>
    
    <Window.KeyBindings>
        <KeyBinding Gesture="Ctrl+C" Command="{Binding CopyCommand}" />
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveCommand}" />
        <KeyBinding Gesture="F3" Command="{Binding PinCommand}" />
    </Window.KeyBindings>

    <Window.Styles>
        <Style Selector="Grid.Handle">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
    </Window.Styles>    

    <Grid Cursor="Cross">
    <Grid>
        <!-- 背景遮罩層 -->
        <Path Fill="#80000000" IsHitTestVisible="False">
            <Path.Data>
                <CombinedGeometry GeometryCombineMode="Exclude">
                    <CombinedGeometry.Geometry1>
                        <RectangleGeometry Rect="0,0,3840,2160" />
                    </CombinedGeometry.Geometry1>
                    <CombinedGeometry.Geometry2>
                        <RectangleGeometry Rect="{Binding SelectionRect}" />
                    </CombinedGeometry.Geometry2>
                </CombinedGeometry>
            </Path.Data>
        </Path>

        <!-- 互動層：使用 Canvas 定位邊框 -->
        <Canvas>
            <!-- 選擇區域容器 -->
            <Grid Width="{Binding SelectionRect.Width}"
                  Height="{Binding SelectionRect.Height}"
                  Canvas.Left="{Binding SelectionRect.X}"
                  Canvas.Top="{Binding SelectionRect.Y}"
                  IsVisible="{Binding CurrentState, Converter={StaticResource StateToBoolConverter}}">
                  
                <!-- BABYMETAL Style Selection Border -->
                <Border CornerRadius="0"
                        Background="#01FFFFFF"
                        BoxShadow="0 0 10 1 #80E60012"> <!-- Red Glow -->
                    <Border.BorderBrush>
                        <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                            <GradientStop Offset="0" Color="{DynamicResource DeepRed}"/>
                            <GradientStop Offset="0.5" Color="{DynamicResource AccentRed}"/>
                            <GradientStop Offset="1" Color="{DynamicResource DeepRed}"/>
                        </LinearGradientBrush>
                    </Border.BorderBrush>
                    <Border BorderThickness="2">
                        <Border BorderBrush="{DynamicResource AccentRedBrush}" BorderThickness="1" Margin="-1">
                            <Grid>
                                <!-- Accent Corners -->
                                <Rectangle Fill="{DynamicResource AccentRedBrush}" Width="15" Height="2" VerticalAlignment="Top" HorizontalAlignment="Left" Margin="2"/>
                                <Rectangle Fill="{DynamicResource AccentRedBrush}" Width="2" Height="15" VerticalAlignment="Top" HorizontalAlignment="Left" Margin="2"/>
                                
                                <Rectangle Fill="{DynamicResource AccentRedBrush}" Width="15" Height="2" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="2"/>
                                <Rectangle Fill="{DynamicResource AccentRedBrush}" Width="2" Height="15" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="2"/>
                                
                                <Rectangle Fill="{DynamicResource AccentRedBrush}" Width="15" Height="2" VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="2"/>
                                <Rectangle Fill="{DynamicResource AccentRedBrush}" Width="2" Height="15" VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="2"/>
                                
                                <Rectangle Fill="{DynamicResource AccentRedBrush}" Width="15" Height="2" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="2"/>
                                <Rectangle Fill="{DynamicResource AccentRedBrush}" Width="2" Height="15" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="2"/>
                            </Grid>
                        </Border>
                    </Border>
                </Border>
                
                <!-- Resize Handles -->
                <!-- Corners -->
                <Grid Classes="Handle" Name="HandleTopLeft" Cursor="TopLeftCorner" Width="30" Height="30" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="-15"/>
                <Grid Classes="Handle" Name="HandleTopRight" Cursor="TopRightCorner" Width="30" Height="30" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="-15"/>
                <Grid Classes="Handle" Name="HandleBottomLeft" Cursor="BottomLeftCorner" Width="30" Height="30" HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="-15"/>
                <Grid Classes="Handle" Name="HandleBottomRight" Cursor="BottomRightCorner" Width="30" Height="30" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="-15"/>
                
                <!-- Sides -->
                <Grid Classes="Handle" Name="HandleTop" Cursor="SizeNorthSouth" Height="15" HorizontalAlignment="Stretch" VerticalAlignment="Top" Margin="15,0"/>
                <Grid Classes="Handle" Name="HandleBottom" Cursor="SizeNorthSouth" Height="15" HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Margin="15,0"/>
                <Grid Classes="Handle" Name="HandleLeft" Cursor="SizeWestEast" Width="15" HorizontalAlignment="Left" VerticalAlignment="Stretch" Margin="0,15"/>
                <Grid Classes="Handle" Name="HandleRight" Cursor="SizeWestEast" Width="15" HorizontalAlignment="Right" VerticalAlignment="Stretch" Margin="0,15"/>
            </Grid>
                    
            <!-- 工具列 (位置綁定) -->
            <ctl:SnipToolbar Canvas.Left="{Binding SelectionRect.Right}" 
                             Canvas.Top="{Binding SelectionRect.Bottom}" 
                             Margin="-100, 5, 0, 0"
                             IsVisible="{Binding CurrentState, Converter={StaticResource StateToBoolConverter}}"/>
             <!-- 這裡位置綁定需要優化，暫時放在選區右下角。理想上應該檢查是否超出螢幕 -->
        </Canvas>
    </Grid>
    </Grid>

</Window>
