<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:GimmeCapture.ViewModels.Floating"
        xmlns:services="using:GimmeCapture.Services.Core"
        xmlns:ctl="using:GimmeCapture.Views.Controls"
        mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="300"
        x:Class="GimmeCapture.Views.Floating.FloatingImageWindow"
        x:DataType="vm:FloatingImageViewModel"
        Title="Pinned Image"
        SystemDecorations="None"
        Topmost="True"
        SizeToContent="WidthAndHeight"
        Background="Transparent"
        FontFamily="{Binding CurrentFontFamily, Source={x:Static services:LocalizationService.Instance}}"
        ShowInTaskbar="False">
        
    <Window.Styles>
        <Style Selector="Grid.Handle">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="IsVisible" Value="{Binding IsSelectionMode, Converter={StaticResource BoolInvertConverter}}"/>
        </Style>
        <Style Selector="Border.MainBorder">
            <Setter Property="BoxShadow" Value="{Binding BorderColor, Converter={StaticResource ColorToBoxShadowConverter}}"/>
            <Setter Property="BorderThickness" Value="{Binding BorderThickness, Converter={StaticResource ThicknessConverter}}"/>
        </Style>
        <Style Selector="Border.MainBorder.hidden-border">
            <Setter Property="BoxShadow" Value="0 0 0 0 Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="Border.InnerBorder.hidden-border">
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
    </Window.Styles>
    
    <Grid Background="Transparent">
        <!-- BABYMETAL Style Border -->
        <Border Margin="{Binding WindowPadding}"
                Classes="MainBorder"
                Classes.hidden-border="{Binding HidePinBorder}"
                CornerRadius="0"
                Background="{DynamicResource GothicBlackBrush}">
            <Border.BorderBrush>
                <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%" Opacity="{Binding HidePinBorder, Converter={StaticResource BoolInvertConverter}}">
                    <GradientStop Offset="0" Color="{Binding BorderColor}"/>
                    <GradientStop Offset="0.5" Color="{Binding BorderColor}"/>
                    <GradientStop Offset="1" Color="{Binding BorderColor}"/>
                </LinearGradientBrush>
            </Border.BorderBrush>
            <Border Classes="InnerBorder">
                <Grid RowDefinitions="*, Auto">
                    <Grid Grid.Row="0">
                        <Border BorderBrush="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}" 
                                BorderThickness="1" Margin="-1" 
                                IsVisible="{Binding HidePinBorder, Converter={StaticResource BoolInvertConverter}}"/>
                        
                        <!-- Checkerboard Background for Transparency Visualization -->
                        <Border IsHitTestVisible="False">
                            <Border.Background>
                                <VisualBrush TileMode="Tile" Stretch="None" SourceRect="0,0,10,10" DestinationRect="0,0,10,10">
                                    <VisualBrush.Visual>
                                        <Canvas Width="10" Height="10" Background="White">
                                            <Rectangle Width="5" Height="5" Fill="#CCCCCC" />
                                            <Rectangle Canvas.Left="5" Canvas.Top="5" Width="5" Height="5" Fill="#CCCCCC" />
                                        </Canvas>
                                    </VisualBrush.Visual>
                                </VisualBrush>
                            </Border.Background>
                        </Border>
                                
                        <!-- Center everything in a shared container to ensure PinnedImage and SelectionCanvas
                             share the exact same coordinate space even if window is larger than image -->
                        <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                            <Image Source="{Binding Image}" 
                                   Stretch="None" 
                                   Name="PinnedImage"/>
                            
                            <!-- Selection Overlay (Over Image Area) -->
                            <Canvas Name="SelectionCanvas" 
                                    Background="Transparent"
                                    IsVisible="{Binding IsSelectionMode}"
                                    IsHitTestVisible="True"
                                    HorizontalAlignment="Stretch"
                                    VerticalAlignment="Stretch"
                                    Cursor="Cross">
                                <Rectangle Canvas.Left="{Binding SelectionRect.X}"
                                           Canvas.Top="{Binding SelectionRect.Y}"
                                           Width="{Binding SelectionRect.Width}"
                                           Height="{Binding SelectionRect.Height}"
                                           Stroke="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                           StrokeThickness="2"
                                           Fill="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                           Opacity="0.3">
                                    <Rectangle.Styles>
                                        <Style Selector="Rectangle">
                                            <Setter Property="StrokeDashArray" Value="4,2"/>
                                        </Style>
                                    </Rectangle.Styles>
                                </Rectangle>
                            </Canvas>
                        </Grid>
                            
                        <!-- Accent Corners (Themed) -->
                        <Grid IsVisible="{Binding HidePinDecoration, Converter={StaticResource BoolInvertConverter}}" Margin="0" ClipToBounds="False">
                            <Grid ClipToBounds="False">
                                <Border BorderThickness="{Binding BorderThickness, Converter={StaticResource ThicknessConverter}}" ClipToBounds="False">
                                    <Border BorderThickness="1" Margin="-1" ClipToBounds="False">
                                        <Grid Name="AccentCornersGrid" ClipToBounds="False">
                                            <!-- Left Inner Corners: Hearts -->
                                            <Rectangle Name="InnerCornerTopLeft" Width="{Binding SelectionIconSize}" Height="{Binding SelectionIconSize}" VerticalAlignment="Top" HorizontalAlignment="Left" Margin="4"
                                                       Fill="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                                       RenderOptions.BitmapInterpolationMode="HighQuality">
                                                <Rectangle.OpacityMask>
                                                    <ImageBrush Source="/Assets/heart.png" Stretch="Uniform"/>
                                                </Rectangle.OpacityMask>
                                            </Rectangle>
                                            <Rectangle Name="InnerCornerBottomLeft" Width="{Binding SelectionIconSize}" Height="{Binding SelectionIconSize}" VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="4"
                                                       Fill="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                                       RenderOptions.BitmapInterpolationMode="HighQuality">
                                                <Rectangle.OpacityMask>
                                                    <ImageBrush Source="/Assets/heart.png" Stretch="Uniform"/>
                                                </Rectangle.OpacityMask>
                                            </Rectangle>

                                            <!-- Right Inner Corners: Skulls -->
                                            <Rectangle Name="InnerCornerTopRight" Width="{Binding SelectionIconSize}" Height="{Binding SelectionIconSize}" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="4"
                                                       Fill="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                                       RenderOptions.BitmapInterpolationMode="HighQuality">
                                                <Rectangle.OpacityMask>
                                                    <ImageBrush Source="/Assets/skull.png" Stretch="Uniform"/>
                                                </Rectangle.OpacityMask>
                                            </Rectangle>
                                            <Rectangle Name="InnerCornerBottomRight" Width="{Binding SelectionIconSize}" Height="{Binding SelectionIconSize}" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="4"
                                                       Fill="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                                       RenderOptions.BitmapInterpolationMode="HighQuality">
                                                <Rectangle.OpacityMask>
                                                    <ImageBrush Source="/Assets/skull.png" Stretch="Uniform"/>
                                                </Rectangle.OpacityMask>
                                            </Rectangle>
                                        </Grid>
                                    </Border>
                                </Border>
                            </Grid>
                            
                             <!-- Wing Decorations Layer -->
                            <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                                  ClipToBounds="False" IsHitTestVisible="False"
                                  IsVisible="{Binding HidePinDecoration, Converter={StaticResource BoolInvertConverter}}">
                                    
                                    <!-- Left Side Wing -->
                                    <Rectangle Width="{Binding WingWidth}" Height="{Binding WingHeight}" VerticalAlignment="Center"
                                               HorizontalAlignment="Left" Margin="{Binding LeftWingMargin}"
                                               Fill="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                               RenderOptions.BitmapInterpolationMode="HighQuality">
                                        <Rectangle.OpacityMask>
                                            <ImageBrush Source="/Assets/wing_left.png" Stretch="Uniform" AlignmentX="Right"/>
                                        </Rectangle.OpacityMask>
                                    </Rectangle>
                                           
                                    <!-- Right Side Wing -->
                                    <Rectangle Width="{Binding WingWidth}" Height="{Binding WingHeight}" VerticalAlignment="Center"
                                               HorizontalAlignment="Right" Margin="{Binding RightWingMargin}"
                                               Fill="{Binding BorderColor, Converter={StaticResource ColorToBrushConverter}}"
                                               RenderOptions.BitmapInterpolationMode="HighQuality">
                                        <Rectangle.OpacityMask>
                                            <ImageBrush Source="/Assets/wing_right.png" Stretch="Uniform" AlignmentX="Left"/>
                                        </Rectangle.OpacityMask>
                                    </Rectangle>
                                </Grid>
                        </Grid>
                        
                        <!-- Resize Handles - 使用負 margin 定位在視覺邊界上 (參考 SnipWindow) -->
                        <Grid Classes="Handle" Name="HandleTopLeft" Cursor="TopLeftCorner" Width="30" Height="30" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="-15"/>
                        <Grid Classes="Handle" Name="HandleTopRight" Cursor="TopRightCorner" Width="30" Height="30" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="-15"/>
                        <Grid Classes="Handle" Name="HandleBottomLeft" Cursor="BottomLeftCorner" Width="30" Height="30" HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="-15"/>
                        <Grid Classes="Handle" Name="HandleBottomRight" Cursor="BottomRightCorner" Width="30" Height="30" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="-15"/>
                        <Grid Classes="Handle" Name="HandleTop" Cursor="TopSide" Height="15" HorizontalAlignment="Stretch" VerticalAlignment="Top" Margin="15,0"/>
                        <Grid Classes="Handle" Name="HandleBottom" Cursor="BottomSide" Height="15" HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Margin="15,0"/>
                        <Grid Classes="Handle" Name="HandleLeft" Cursor="LeftSide" Width="15" HorizontalAlignment="Left" VerticalAlignment="Stretch" Margin="0,15"/>
                        <Grid Classes="Handle" Name="HandleRight" Cursor="RightSide" Width="15" HorizontalAlignment="Right" VerticalAlignment="Stretch" Margin="0,15"/>
                    </Grid>

                    <!-- Bottom Toolbar -->
                    <Border Grid.Row="1" IsVisible="{Binding ShowToolbar}" 
                            Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1" 
                            CornerRadius="4" Padding="2" Margin="0,4,0,0"
                            HorizontalAlignment="Center" VerticalAlignment="Top"
                            BoxShadow="0 2 8 0 #A0000000">
                        <StackPanel Orientation="Horizontal" Spacing="2">
                            <Button Theme="{StaticResource SnipButton}" Command="{Binding CopyCommand}" ToolTip.Tip="{Binding [TipCopy], Source={x:Static services:LocalizationService.Instance}}">
                                <PathIcon Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" Width="14" Height="14"/>
                            </Button>
                            
                            <Button Theme="{StaticResource SnipButton}" Command="{Binding SaveCommand}" ToolTip.Tip="{Binding [TipSave], Source={x:Static services:LocalizationService.Instance}}">
                                <PathIcon Data="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" Width="14" Height="14"/>
                            </Button>
                            <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center"/>
                            <Button Theme="{StaticResource SnipButton}" Command="{Binding CloseCommand}" ToolTip.Tip="{Binding [MenuClose], Source={x:Static services:LocalizationService.Instance}}">
                                <PathIcon Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" Width="14" Height="14"/>
                            </Button>
                            
                            <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center"/>
                            
                            <!-- Selection Tool -->
                            <ToggleButton Theme="{StaticResource SnipToggleButton}" 
                                          IsChecked="{Binding IsSelectionMode, Mode=TwoWay}"
                                          ToolTip.Tip="Selection Area">
                                <PathIcon Data="M2,4H4V2H2A2,2 0 0,0 0,4V6H2V4M22,2H20V4H22V6H24V4A2,2 0 0,0 22,2M2,22V20H0V22A2,2 0 0,0 2,24H4V22H2M22,24A2,2 0 0,0 24,22V20H22V22H20V24H22M2,10H0V14H2V10M2,18H0V19A1,1 0 0,0 1,20H2V18M14,2H10V4H14V2M18,2H17A1,1 0 0,0 16,3V4H18V2M1,4V3A1,1 0 0,0 0,2H1V4M24,10H22V14H24V10M24,18H22V20H23A1,1 0 0,0 24,19V18M14,22H10V24H14V22M18,22V24H19A1,1 0 0,0 20,23V22H18M4,2H3A1,1 0 0,0 2,1V2H4Z" Width="12" Height="12"/>
                            </ToggleButton>
                            
                            <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center" IsVisible="{Binding IsSelectionActive}"/>
                            
                            <!-- Crop Button -->
                            <Button Theme="{StaticResource SnipButton}" 
                                    Command="{Binding CropCommand}" 
                                    IsVisible="{Binding IsSelectionActive}"
                                    ToolTip.Tip="{Binding [TipCrop], Source={x:Static services:LocalizationService.Instance}}">
                                <PathIcon Data="M7,17V1H5V5H1V7H5V15A2,2 0 0,0 7,17H15V21H17V17H21V15H7V17M17,15H19V7C19,5.89 18.1,5 17,5H9V7H17V15Z" Width="14" Height="14"/>
                            </Button>
                            
                            <!-- Pin Selection Button -->
                            <Button Theme="{StaticResource SnipButton}" 
                                    Command="{Binding PinSelectionCommand}" 
                                    IsVisible="{Binding IsSelectionActive}"
                                    ToolTip.Tip="{Binding [TipPinSelection], Source={x:Static services:LocalizationService.Instance}}">
                                <PathIcon Data="M16,12V4H17V2H7V4H8V12L6,14V16H11V22H13V16H18V14L16,12M14,14H10V4H14V14Z" Width="14" Height="14"/>
                            </Button>

                            <!-- Undo / Redo -->
                            <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center" IsVisible="{Binding HasUndo}"/>
                            <Button Theme="{StaticResource SnipButton}" Command="{Binding UndoCommand}" ToolTip.Tip="{Binding [Undo], Source={x:Static services:LocalizationService.Instance}}" IsVisible="{Binding HasUndo}">
                                <PathIcon Data="M12.5,8C9.85,8 7.45,9 5.6,10.6L2,7V16H11L7.38,12.38C8.77,11.22 10.54,10.5 12.5,10.5C16.04,10.5 19.05,12.81 20.1,16L22.47,15.22C21.08,11.03 17.15,8 12.5,8Z" Width="14" Height="14"/>
                            </Button>
                            <Button Theme="{StaticResource SnipButton}" Command="{Binding RedoCommand}" ToolTip.Tip="Redo" IsVisible="{Binding HasRedo}">
                                <PathIcon Data="M18.4,10.6C16.55,9 14.15,8 11.5,8C6.85,8 2.92,11.03 1.54,15.22L3.9,16C4.95,12.81 7.95,10.5 11.5,10.5C13.45,10.5 15.23,11.22 16.62,12.38L13,16H22V7L18.4,10.6Z" Width="14" Height="14"/>
                            </Button>
                             
                             <!-- Remove Background Button -->
                            <Rectangle Fill="#444444" Width="1" Height="16" Margin="2,0" VerticalAlignment="Center" IsVisible="{Binding CanRemoveBackground}"/>
                            <Button Theme="{StaticResource SnipButton}" Command="{Binding RemoveBackgroundCommand}" ToolTip.Tip="{Binding [RemoveBackground], Source={x:Static services:LocalizationService.Instance}}" IsVisible="{Binding CanRemoveBackground}">
                                <PathIcon Data="M7.5,5.6L5,7L6.4,4.5L5,2L7.5,3.4L10,2L8.6,4.5L10,7L7.5,5.6M19.5,15.4L22,14L20.6,16.5L22,19L19.5,17.6L17,19L18.4,16.5L17,14L19.5,15.4M22,2L20.6,4.5L22,7L19.5,5.6L17,7L18.4,4.5L17,2L19.5,3.4L22,2M13.34,12.78L15.78,10.34L13.66,8.22L11.22,10.66L13.34,12.78M14.37,7.29L16.71,9.63C17.1,10 17.1,10.65 16.71,11.04L5.04,22.71C4.65,23.1 4,23.1 3.63,22.71L1.29,20.37C0.9,20 0.9,19.35 1.29,18.96L12.96,7.29C13.35,6.9 14,6.9 14.37,7.29Z" Width="14" Height="14"/>
                            </Button>
                        </StackPanel>
                    </Border>
                    
                    <!-- Processing Overlay -->
                    <Border Grid.Row="0" Grid.RowSpan="2" IsVisible="{Binding IsProcessing}">
                         <ctl:ProcessingOverlay DataContext="{Binding}"/>
                    </Border>
                </Grid>
            </Border>
            
            <Border.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="{Binding [MenuCopyImage], Source={x:Static services:LocalizationService.Instance}}" Command="{Binding CopyCommand}"/>
                    <MenuItem Header="{Binding [MenuCrop], Source={x:Static services:LocalizationService.Instance}}" Command="{Binding CropCommand}" IsVisible="{Binding IsSelectionActive}"/>
                    <MenuItem Header="{Binding [MenuPinSelection], Source={x:Static services:LocalizationService.Instance}}" Command="{Binding PinSelectionCommand}" IsVisible="{Binding IsSelectionActive}"/>
                    <MenuItem Header="{Binding [MenuSaveImage], Source={x:Static services:LocalizationService.Instance}}" Command="{Binding SaveCommand}"/>
                    <Separator/>
                    <MenuItem Header="{Binding [MenuShowToolbar], Source={x:Static services:LocalizationService.Instance}}" 
                              Command="{Binding ToggleToolbarCommand}">
                        <MenuItem.Icon>
                            <CheckBox IsChecked="{Binding ShowToolbar}" IsHitTestVisible="False"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="{Binding [MenuClose], Source={x:Static services:LocalizationService.Instance}}" Command="{Binding CloseCommand}"/>
                </ContextMenu>
            </Border.ContextMenu>
        </Border>
    </Grid>
</Window>
